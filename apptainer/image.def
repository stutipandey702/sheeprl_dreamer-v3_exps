Bootstrap: docker
From: pytorch/pytorch:2.9.0-cuda12.8-cudnn9-runtime

%labels
    Author YourName
    Description "Container for MiniWorld/Gymnasium with PyTorch and GPU OpenGL support"

%environment
    # Always use software OpenGL where needed
    export LIBGL_ALWAYS_SOFTWARE=1
    # Use EGL as default OpenGL backend for PyOpenGL
    export PYOPENGL_PLATFORM=osmesa

%post
    chmod 777 /tmp
    # System packages
    apt-get update -y
    apt-get install -y \
        vim \
        python3.10 \
        python3-opengl \
        python3-pip \
        python3-venv \
        libglib2.0-0 \
        libsm6 \
        libxext6 \
        libxrender1 \
        libosmesa6 \
        freeglut3-dev \
        libglu1-mesa \
        libgl1-mesa-dri \
        xvfb \
        git \
        swig \
        && apt-get clean && rm -rf /var/lib/apt/lists/*
    
   # Upgrade pip
    python3 -m pip install --upgrade pip setuptools wheel
    
    # Install PyTorch
    python3 -m pip install torch torchvision --index-url https://download.pytorch.org/whl/cu126
    
    # Core dependencies from pyproject.toml
    python3 -m pip install \
        "gymnasium==0.29.*" \
        "pygame>=2.1.3" \
        "moviepy>=1.0.3" \
        "tensorboard>=2.10" \
        "python-dotenv>=1.0.0" \
        "lightning>=2.0" \
        "lightning-utilities<=0.9" \
        "hydra-core==1.3.0" \
        "torchmetrics" \
        "rich==13.5.*" \
        "opencv-python==4.8.0.*" \
        "numpy<2.0"

    # Optional / extra dependencies (if you need them)
    python3 -m pip install \
        "miniworld" \
        "minigrid" \
        "crafter==1.8.3" \
        "ogbench" \
        "gym-sokoban" \
        "pyglet" \
        "matplotlib" \
        "pyyaml" \
        "wandb"
    
    
    # Force numpy<2 at the end
    python3 -m pip install "numpy<2" --force-reinstall --no-deps
    /opt/conda/bin/pip install "numpy<2" --force-reinstall --no-deps